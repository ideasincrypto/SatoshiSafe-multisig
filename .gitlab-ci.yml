image: node:lts-alpine

before_script:
    - cd frontend && yarn install

cache:
    paths:
        - frontend/node_modules
        - frontend/yarn.lock

stages:
    - test
    - build
    - deploy

.unit-test-job:
    stage: test
    script:
        - echo "Running unit tests... This will take about 60 seconds."
        - sleep 60
        - echo "Code coverage is 90%"

lint-test-job:
    stage: test
    script:
        - echo "Linting code... This will take about 10 seconds."
        - yarn eslint:verify
        - echo "No lint issues found."

format-test-job:
    stage: test
    script:
        - echo "Formatting code... This will take about 10 seconds."
        - yarn format:verify
        - echo "No format issues found."

build-job:
    stage: build
    script:
        - echo "Compiling the code..."
        - yarn build:playground
        - echo "Compile complete."
    only:
        - main
    artifacts:
        paths:
            - $CI_PROJECT_DIR/frontend/dist
        expire_in: 1 week

deploy-playground-job:
    stage: deploy
    only:
        - main
    dependencies:
        - build-job
    before_script:
        - yarn global add firebase-tools
    script:
        - echo "Deploying application..."
        - cd $CI_PROJECT_DIR/frontend
        - export GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS_PLAYGROUND && firebase deploy --only hosting --project playground
        - echo "Application successfully deployed."
